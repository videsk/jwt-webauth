!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebAuth=t():e.WebAuth=t()}(window,function(){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";var r,n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}();function i(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var a=o(1).version,c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var o=t.keys,r=void 0===o?{accessToken:"auth-key",refreshToken:"auth-key-refresh"}:o,n=t.config,s=void 0===n?{endpoints:{hostname:"http://localhost:3000/",accessToken:{url:"check-token",method:"GET",authorizationType:"Bearer",headers:{"Content-Type":"application/json"},body:{},keys:{accessToken:"accessToken",refreshToken:"refreshToken"},status:{expired:401,ok:200},attempts:3},refreshToken:{url:"refresh-token",method:"POST",authorizationType:"Bearer",headers:{"Content-Type":"application/json"},body:{},keys:{accessToken:"accessToken",refreshToken:"refreshToken"},status:{expired:401,ok:201},attempts:3}}}:n;this.keys=r,this.events={expired:function(){},error:function(){},renewed:function(){},empty:function(){},load:function(){}},this.config=s,this.storage=window.localStorage.getItem(this.keys.accessToken)?"localStorage":"sessionStorage",this._stop=!1,this.version=a,this._load=!1,this.stop=this.logout}return s(e,[{key:"set",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments[2];this._stop=!1,"boolean"==typeof o&&(this.storage=o?"localStorage":"sessionStorage");var r=this.constructor.getTokens(this.storage,this.keys),n=r.accessToken,s=void 0===n?e:n,i=r.refreshToken,a=void 0===i?t:i;if(!s)return this.events.empty();this.verifyJWT(s,"accessToken"),a&&this.verifyJWT(a,"refreshToken"),this.constructor.saveTokens(this.storage,this.keys,s,a);try{return await this.askServer(),this.observer()}catch(e){return e instanceof Error?this.events.error(e):(this.events.expired("accessToken"),this.renew())}}},{key:"on",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};this.events[e]=t}},{key:"clean",value:function(){window.localStorage.removeItem(this.keys.accessToken),window.localStorage.removeItem(this.keys.refreshToken),window.sessionStorage.removeItem(this.keys.accessToken),window.sessionStorage.removeItem(this.keys.refreshToken)}},{key:"observer",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,o=this.constructor.getTokens(this.storage,this.keys),r=o.accessToken,n=o.refreshToken;if(!this._stop&&r){var s=(new Date).getTime()>this.constructor.getExpirationToken(r);if(s||this._load||(this._load=!0,this.events.load()),!s)return setTimeout(function(){return e.observer()},1e3);if(t<2&&this.events.expired("accessToken"),n)return this.renew(t)}}},{key:"renew",value:async function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,o=this.constructor.getTokens(this.storage,this.keys,"refreshToken"),r=(new Date).getTime()>this.constructor.getExpirationToken(o);if(r)return this.events.expired("refreshToken");var n=this.config.endpoints.refreshToken;try{var s=n.keys.accessToken,i=await this.askServer("refreshToken");return this.constructor.saveTokens(this.storage,this.keys,i[s],o),this.events.renewed(),this.observer()}catch(o){if(!(o instanceof Error))return;if(t>=n.attempts)return this.events.error(o);setTimeout(function(){return e.observer(t+1)},1e3*(t+1))}}},{key:"askServer",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"accessToken";if(!this._stop){var t=this.config.endpoints[e],o=t.url,r=t.body,n=t.headers,s=t.method,a=t.authorizationType,c=t.keys,u=t.status,h=this.constructor.getTokens(this.storage,this.keys),f=Object.assign(n,{Authorization:a+" "+h[e]}),l=Object.assign(r,i({},c[e],h[e])),d=""+this.config.endpoints.hostname+o,v={method:s,headers:f};["post","patch","put"].includes(s.toLowerCase())&&(v.body=JSON.stringify(l));var p=await fetch(d,v);if(p.status===u.ok||Array.isArray(u.ok)&&u.ok.includes(p.status))return p.json();if(p.status!==u.expired&&p instanceof Error||Array.isArray(u.expired)&&p.expired.includes(p.status))throw p;throw this.events.expired(e)}}},{key:"logout",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._stop=e,this._load=!1,this.clean()}},{key:"verifyJWT",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{JSON.parse(atob(e.split(".")[1]))}catch(e){throw this.events.error(e),new Error(t+" is not valid JWT.")}}}],[{key:"getTokens",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sessionStorage",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=window[e].getItem(t.accessToken),n=window[e].getItem(t.refreshToken);return o?"accessToken"===o?r:n:r||n?{accessToken:r,refreshToken:n}:{}}},{key:"saveTokens",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sessionStorage",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";window[e].setItem(t.accessToken,o),window[e].setItem(t.refreshToken,r)}},{key:"getExpirationToken",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=JSON.parse(atob(e.split(".")[1]));if("object"!==(void 0===t?"undefined":n(t)))throw new Error("Invalid JWT, please check.");return"exp"in t?1e3*t.exp:1/0}},{key:"getStorage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return window.localStorage.getItem(e)?"localStorage":"sessionStorage"}}]),e}();void 0===(r=function(){return c}.apply(t,[]))||(e.exports=r),e.exports=c},function(e){e.exports=JSON.parse('{"name":"@videsk/front-auth-handler","version":"3.2.1","description":"A Javascript frontend authorization key handler for works with JWT.","main":"index.js","scripts":{"build":"webpack","start-server":"node ./test/server.js","test":"start-server-and-test start-server :8080 testing","testing":"cypress open"},"keywords":["authorization","webauth","JWT","key","frontend"],"author":"videsk","repository":{"type":"git","url":"https://github.com/videsk/front-auth-handler.git"},"homepage":"https://developers.videsk.io","license":"LGPL-2.1","devDependencies":{"@videsk/window-node-polyfill":"^1.0.1","atob":"^2.1.2","auth-header":"^1.0.0","babel-core":"^6.26.3","babel-loader":"^7.1.5","babel-preset-es2015":"^6.24.1","body-parser":"^1.19.0","chai":"^4.3.3","chai-http":"^4.3.0","cypress":"^6.6.0","express":"^4.17.1","jsonwebtoken":"^8.5.1","mocha":"^8.3.0","node-fetch":"^2.6.1","nyc":"^15.1.0","socket.io":"^3.1.2","start-server-and-test":"^1.12.0","webpack":"^4.39.1","webpack-cli":"^3.3.6"}}')}])});
//# sourceMappingURL=web-auth.min.js.map